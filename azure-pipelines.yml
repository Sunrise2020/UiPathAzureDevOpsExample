trigger:
  - master
variables:
  - group: DEV

stages:
  - stage: Build
    displayName: Build Package
    pool: $(AGENTS)
    jobs: 
    - job: BuildPackage
      steps:    
      - task: UiPathPack@2
        inputs:
          versionType: 'AutoVersion'
          projectJsonPath: '$(Build.SourcesDirectory)\project.json'
          outputType: 'Process'
          orchestratorConnection: 'UIPath Orchestrator'
          outputPath: '$(Build.ArtifactStagingDirectory)'
      - publish: $(Build.ArtifactStagingDirectory)
        artifact: drop

    - job: BuildTestProject
      steps:
      - task: UiPathPack@2
        inputs:
          versionType: 'AutoVersion'
          projectJsonPath: '$(Build.SourcesDirectory)\project.json'
          outputType: 'Tests'
          orchestratorConnection: 'UIPath Orchestrator'
          outputPath: '$(Build.ArtifactStagingDirectory)'
      - publish: $(Build.ArtifactStagingDirectory)
        artifact: tests

  - stage: Assest
    displayName: Create Assests
    pool: $(AGENTS)
    jobs:
      - job: CreateAssests
        # pool: Azure Pipelines
        steps:
        - task: UiPathAssets@2
          inputs:
            orchestratorConnection: 'UIPath Orchestrator'
            folderName: 'Shared'
            assetActionType: 'Deploy'
            csvFile: '$(Build.SourcesDirectory)\Data\Assests.csv'

  - stage: DeployDEV
    pool: $(AGENTS)
    displayName: Deploy build artifact to DEV
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: deployDEV
        displayName: Deploy package to DEV Orchestrator
        # pool: Azure Pipelines
        environment: DEV
        strategy:
         runOnce:
          deploy:
           steps:
            - task: UiPathDeploy@2
              inputs:
                orchestratorConnection: 'UIPath Orchestrator'
                packagesPath: '$(Pipeline.Workspace)\drop\'
                folderName: 'Shared'
            - task: UiPathDeploy@2
              inputs:
                orchestratorConnection: 'UIPath Orchestrator'
                packagesPath: '$(Pipeline.Workspace)\tests\'
                folderName: 'Shared/TestCases'
                
  - stage: WorkflowAnalyser
    displayName: RunWorkflow Analyser
    dependsOn: Build
    condition: succeeded()
    pool: $(AGENTS)
    jobs:
        - job: WorkflowAnalyser
          displayName: AnalyseProject Using Workflow Cli
          # pool: Azure Pipelines
          steps:
          - task: PowerShell@2
            inputs:
              targetType: filePath
              filePath: $(Build.SourcesDirectory)\Data\Workflow-Analyzer-CLI-Script
              arguments: > # Use this to avoid newline characters in multiline string
                -ProjectFilePath $(Build.SourcesDirectory)\project.json
                -ExecutableFilePath "C:\Users\prasa\AppData\Local\UiPath\app-21.4.4\UiPath.Studio.CommandLine.exe"
                -OutputFilePath '$(Pipeline.Workspace)\drop\Workflow-Analysis.json'
              workingDirectory: $(Build.SourcesDirectory)
            displayName: 'Analyse Project'

#  - stage: TestDEV
#    displayName:  Test After Publish
#    dependsOn: DeployDEV
#    condition: succeeded()
#    pool: $(AGENTS)
#    jobs:
#      - job: TestDEV
#        steps:
#          - task: UiPathTest@2
#            inputs:
#              testTarget: 'TestSet'
#              orchestratorConnection: 'UIPath Orchestrator'
#              testSet: 'UiPathAzureDevOps_Tests'
#              folderName: 'Shared'
#              testReportDestination: '$(Pipeline.Workspace)\tests\'

  - stage: TestExec
    displayName:  Test Case Execution
    dependsOn: DeployDEV
    condition: succeeded()
    pool: $(AGENTS)
    jobs:
      - job: TestExec
        steps:
          - task: UiPathTest@2
            inputs:
              testTarget: 'TestProject'
              orchestratorConnection: 'UIPath Orchestrator'
              folderName: 'Shared/TestCases'
              testReportDestination: '$(Pipeline.Workspace)\tests\'
              traceLevel: 'Information'

